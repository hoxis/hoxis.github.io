<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">
<meta name="google-site-verification" content="B7lUGKNplO6JqOkIcuTGZN1PEfj8inK2ZVhJw5Z3HQ0">
<meta name="baidu-site-verification" content="qzPNJMTINu">
<meta name="baidu-site-verification" content="pg0OpMkHdJ">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">




  
  
  <link rel="stylesheet" media="all" href="/lib/Han/dist/han.min.css?v=3.3">




<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">

















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.proxy.ustclug.org/css?family=Verdana:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/favicon2.ico?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/favicon1.ico?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Spring,">





  <link rel="alternate" href="/atom.xml" title="hoxis' blog" type="application/atom+xml">






<meta name="description" content="本章主要内容：  备用的Spring MVC配置项 处理文件上传 控制器中的异常处理 使用flash属性">
<meta name="keywords" content="Spring">
<meta property="og:type" content="article">
<meta property="og:title" content="《Spring实战》学习笔记-第七章：Spring MVC进阶">
<meta property="og:url" content="https://hoxis.github.io/《Spring实战》学习笔记-第七章：Spring MVC进阶.html">
<meta property="og:site_name" content="hoxis&#39; blog">
<meta property="og:description" content="本章主要内容：  备用的Spring MVC配置项 处理文件上传 控制器中的异常处理 使用flash属性">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://hoxis-github-io.qiniudn.com/160428-spring-in-action-7.1.png">
<meta property="og:image" content="http://hoxis-github-io.qiniudn.com/160428-spring-in-action-7.2.png">
<meta property="og:updated_time" content="2019-07-30T06:20:15.702Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="《Spring实战》学习笔记-第七章：Spring MVC进阶">
<meta name="twitter:description" content="本章主要内容：  备用的Spring MVC配置项 处理文件上传 控制器中的异常处理 使用flash属性">
<meta name="twitter:image" content="http://hoxis-github-io.qiniudn.com/160428-spring-in-action-7.1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":10,"b2t":false,"scrollpercent":true,"onmobile":true},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://hoxis.github.io/《Spring实战》学习笔记-第七章：Spring MVC进阶.html">





<!-- 添加DaoVioce -->

  <script>
  (function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/0f81ff2f.js","daovoice")
  daovoice('init', {
      app_id: "7f3d6e70"
    });
  daovoice('update');
  </script>


  <title>《Spring实战》学习笔记-第七章：Spring MVC进阶 | hoxis' blog</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?f502d954566dcd3865de243d3125357d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  
  <!-- 页面点击小红心 
<script type="text/javascript" src="/js/src/love.js"></script>-->

<script type="text/javascript" src="/js/src/click.js"></script>

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <a href="https://github.com/hoxis" class="github-corner" aria-label="View source on Github"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#70B7FD; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">hoxis' blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">生命在于折腾</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-top">
          <a href="/top/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-signal"></i> <br>
            
            热榜
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-reading">
          <a href="/reading/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br>
            
            阅读
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-resources">
          <a href="/resources/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-cloud-download"></i> <br>
            
            资源
          </a>
        </li>
      
        
        <li class="menu-item menu-item-baidu">
          <a href="/baidu/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-cloud"></i> <br>
            
            百度
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
			<div id="container">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hoxis.github.io/《Spring实战》学习笔记-第七章：Spring MVC进阶.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="hoxis">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hoxis' blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">《Spring实战》学习笔记-第七章：Spring MVC进阶</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-04-29T10:19:04+08:00">
                2016-04-29
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/学习笔记/" itemprop="url" rel="index">
                    <span itemprop="name">学习笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/《Spring实战》学习笔记-第七章：Spring MVC进阶.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/《Spring实战》学习笔记-第七章：Spring MVC进阶.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/《Spring实战》学习笔记-第七章：Spring MVC进阶.html" class="leancloud_visitors" data-flag-title="《Spring实战》学习笔记-第七章：Spring MVC进阶">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  8,555
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  34
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        <p>本章主要内容：</p>
<ul>
<li>备用的Spring MVC配置项</li>
<li>处理文件上传</li>
<li>控制器中的异常处理</li>
<li>使用flash属性</li>
</ul>
<a id="more"></a>
<p>“等等，客官！不止这些”</p>
<p>也许大家在看电视广告时对上面这句话比较熟悉，广告里通常在已经对商品做了完整的介绍，这时，电视里就会冒出这句：等等，客官，还不止这些。。。接着，就会继续吹嘘他们的商品还有更多让你意想不到的功能。</p>
<p>其实，Spring MVC（或者说Spring的每一个模块）就给人一种“不止这些”的感觉，就在你以为已经对Spring MVC的功能有了完备的了解时，又会发现可以利用它做的更多。</p>
<p>在第五章中，我们使用Spring MVC的基本功能以及如何编写控制器来处理各种各样的请求。接着在第六章中创建了JSP和Thymeleaf视图来将model数据对用户进行了展示。也许你会觉得Spring MVC不过如此。但是等等，还不止这些！</p>
<p>本章中会继续讨论Spring MVC，比如编写控制器来处理文件上传，如何处理控制器中的异常，以及如何在model上传递数据从而可以在重定向时使用。</p>
<p>首先，在第五章中使用了<code>AbstractAnnotationConfigDispatcherServletInitializer</code>来设置Spring MVC，并且说了可以使用其他备用设置选择。因此在文件上传和异常处理之前，先来探索一下如何使用其他方式来设置<code>DispatcherServlet</code>和<code>ContextLoaderListener</code>。</p>
<h1><span id="spring-mvc备用配置">Spring MVC备用配置</span></h1><p>第五章中，通过继承<code>AbstractAnnotationConfigDispatcherServletInitializer</code>来快速地对Spring MVC进行了设置。该类假设你想要一个基础的<code>DispatcherServlet</code>和<code>ContextLoaderListener</code>设置，并且通过Java而不是XML文件来配置Spring。</p>
<p>尽管这样配置对大多数Spring应用都是适用的，但是总有意外，比如你想要除了DispatcherServlet之外的servlet和filter，或者你想对DispatcherServlet做一些进一步的配置，再或者，你想在Servlet3.0之前的版本上部署应用，那么你就要使用传统的web.xml文件对DispatcherServlet进行配置了。</p>
<p>幸运的是，在（garden-variety）普通的AbstractAnnotationConfigDispatcherServletInitializer不适用于你的需求时，还有其他的一些方式供你使用。下面，我们就开始如何定制化的配置DispatcherServlet吧。</p>
<h2><span id="dispatcherservlet个性化配置">DispatcherServlet个性化配置</span></h2><p>SpittrWebAppInitializer中所包含的三个方法仅仅是必须重写的三个抽象方法，同时还有许多其他方法可以重写从而可以实现更多的配置。</p>
<p>其中一个就是<code>customizeRegistration()</code>，在AbstractAnnotationConfigDispatcherServletInitializer注册了DispatcherServlet之后，就会调用customizeRegistration()方法，并根据servlet的注册返回值传送<code>ServletRegistration.Dynamic</code>，通过对<code>customizeRegistration()</code>的重写，就可以对DispatcherServlet进行额外的配置。</p>
<p>比如，在稍后的章节中（7.2），你会看到Spring MVC如何处理多个请求和文件上传。如果打算使用Servlet3.0来实现多部分配置，那么就需要激活DispatcherServlet配置来实现多路请求。可以使用下面的方式重写customizeRegistration()方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">customizeRegistration</span><span class="params">(Dynamic registration)</span> </span>&#123;</span><br><span class="line">    registration.setMultipartConfig(</span><br><span class="line">        <span class="keyword">new</span> MultipartConfigElement(<span class="string">"/tmp/spittr/uploads"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中ServletRegistration.Dynamic作为入参，你可以做很多事情，比如调用<code>setLoadOnStartup()</code>来设置加载时优先级，调用<code>setInitParameter()</code>来设置初始化参数，调用<code>setMultipartConfig()</code>来设置Servlet3.0的多路支持。在上述示例中，设置了多路支持的上传文件临时存储路径为：/tmp/spittr/uploads。</p>
<h2><span id="添加额外的servlet和filter">添加额外的servlet和filter</span></h2><p>根据之前的配置，可以生成DispatcherServlet和ContextLoaderListener，但是你需要注册额外的servlet、filter或者listener时怎么办呢？</p>
<p>使用基于Java配置的一个好处就是你可以尽量多的定义初始化类。因此，如果需要定义额外的组件，只需新建相应的初始化类即可。最简单的方法就是实现Spring的<code>WebApplicationInitializer</code>接口。</p>
<p>例如，下面的代码展示了如何通过实现<code>WebApplicationInitializer</code>接口的方式来注册一个servlet：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.ServletContext;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRegistration.Dynamic;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.WebApplicationInitializer;</span><br><span class="line"><span class="keyword">import</span> com.myapp.MyServlet;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyServletInitializer</span> <span class="keyword">implements</span> <span class="title">WebApplicationInitializer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStartup</span><span class="params">(ServletContext servletContext)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">        <span class="comment">// 定义servlet</span></span><br><span class="line">        Dynamic myServlet = servletContext.addServlet(<span class="string">"myServlet"</span>, MyServlet.class);</span><br><span class="line">        <span class="comment">// 映射servlet</span></span><br><span class="line">        myServlet.addMapping(<span class="string">"/custom/**"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上述代码仅仅是一个基本的servlet注册初始化类，实现了对servlet的注册并映射到一个路径。你也可以使用这种方式来手动地注册DispatcherServlet（不过这好像没有必要，因为AbstractAnnotationConfigDispatcherServletInitializer在这方面已经做得很不错了）。</p>
<p>同样的，你也可以通过上述方式来注册listener和filter。例如：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStartup</span><span class="params">(ServletContext servletContext)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">    <span class="comment">// 注册一个filter</span></span><br><span class="line">    javax.servlet.FilterRegistration.Dynamic filter = servletContext.addFilter(<span class="string">"myFilter"</span>, MyFilter.class);</span><br><span class="line">    <span class="comment">// 添加映射</span></span><br><span class="line">    filter.addMappingForUrlPatterns(<span class="keyword">null</span>, <span class="keyword">false</span>, <span class="string">"/custom/*"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>WebApplicationInitializer</code>是一个在注册servlet、filter、listener时比较推荐的方式，当然你是使用基于Java的配置方式并将应用部署在Servlet3.0容器上的。如果你仅仅需要注册一个filter并将其映射到<code>DispatcherServlet</code>，那么使用<code>AbstractAnnotationConfigDispatcherServletInitializer</code>将是一个捷径。</p>
<p>要注册多个filter并将它们映射到DispatcherServlet，你所要做的仅仅是重写<code>getServletFilters()</code>方法。比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> Filter[] getServletFilters() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Filter[] &#123; <span class="keyword">new</span> MyFilter() &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如你所见，该方法返回了一个<code>javax.servlet.Filter</code>的数组，这里仅仅返回了一个filter，但是它可以返回很多个。同时这里不再需要为这些filter去声明映射，因为通过getServletFilters()返回的filter会自动地映射到DispatcherServlet。</p>
<p>当部署到Servlet3.0的容器时，Spring提供了很多方法来注册servlet、filter和listener，而不再需要web.xml。如果你使用的不是Servlet3.0版本的容器，或者你就喜欢使用基于web.xml的配置方式，那么该如何对Spring MVC进行配置呢？</p>
<h2><span id="使用webxml声明dispatcherservlet">使用web.xml声明DispatcherServlet</span></h2><p>下面是一个典型的web.xml文件，其中对DispatcherServlet和ContextLoaderListener进行了声明：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">version</span>=<span class="string">"2.5"</span> <span class="attr">xmlns</span>=<span class="string">"http://java.sun.com/xml/ns/javaee"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xsi:schemaLocation</span>=<span class="string">"http://java.sun.com/xml/ns/javaee</span></span></span><br><span class="line"><span class="tag"><span class="string">http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">context-param</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">param-value</span>&gt;</span>/WEB-INF/spring/root-context.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- 注册ContextLoaderListener --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>appServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- 注册DispatcherServlet --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- DispatcherServlet映射 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>appServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>正如在第五章中所说的，DispatcherServlet和ContextLoaderListener可以加载Spring应用上下文。contextConfigLocation上下文参数指定了用来定义由ContextLoaderListener加载的根应用上下文的XML文件的位置。DispatcherServlet用来通过文件中定义的bean（名称基于指定的servlet名称：appServlet）来加载应用上下文。因此，DispatcherServlet会从/WEB-INF/appServlet-context.xml文件中加载应用上下文。</p>
<p>如果你想指定DispatcherServlet配置文件的位置，那么可以通过设置contextConfigLocation初始化参数的方式实现。例如，下面的DispatcherServlet配置就会从/WEB-INF/spring/appServlet/servlet-context.xml文件中加载：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>appServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 注册DispatcherServlet --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">param-value</span>&gt;</span></span><br><span class="line">			/WEB-INF/spring/appServlet/servlet-context.xml</span><br><span class="line">		<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">```	</span><br><span class="line">本书中采用的都是基于Java的配置方式，所以你需要对Spring MVC进行设置从而可以从`@Configuration`注解的类中加载配置。为了使用基于Java的配置，需要通知DispatcherServlet和ContextLoaderListener去使用AnnotationConfigWebApplicationContext，该类是`WebApplicationContext`接口的实现类，它可以对Java配置类进行加载。可以通过设置DispatcherServlet的`contextClass`参数和初始化参数来实现。下面对web.xml进行配置从而可以使用Java配置：</span><br><span class="line">```xml</span><br><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">version</span>=<span class="string">"2.5"</span> <span class="attr">xmlns</span>=<span class="string">"http://java.sun.com/xml/ns/javaee"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xsi:schemaLocation</span>=<span class="string">"http://java.sun.com/xml/ns/javaee</span></span></span><br><span class="line"><span class="tag"><span class="string">http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 使用Java配置 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">context-param</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextClass<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">param-value</span>&gt;</span></span><br><span class="line">			org.springframework.web.context.support.AnnotationConfigWebApplicationContext</span><br><span class="line">		<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">&lt;!-- 指定所使用的Java配置类 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">context-param</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">param-value</span>&gt;</span>spittr.config.RootConfig<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">listener-class</span>&gt;</span></span><br><span class="line">			org.springframework.web.context.ContextLoaderListener</span><br><span class="line">		<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>appServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- 使用Java配置 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextClass<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">param-value</span>&gt;</span></span><br><span class="line">				org.springframework.web.context.support.AnnotationConfigWebApplicationContext</span><br><span class="line">			<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- 指定DispatcherServlet的配置类 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">param-value</span>&gt;</span></span><br><span class="line">				spittr.config.WebConfigConfig</span><br><span class="line">			<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>appServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>以上就是配置Spring MVC的一些方法，下面来看如何使用Spring MVC处理文件上传。</p>
<h1><span id="处理multipart表单数据">处理multipart表单数据</span></h1><p>一个web应用通常都会允许用户上传内容，比如像Facebook、Flickr这样的站点，都会允许用户上传小片的。我们的Spittr应用中在两处会用到文件上传：一是新用户注册的时候，这时需要选择一个头像之类的；还有就是当用户新建一个Spittle（推文？）时，也许需要在文中插入一张图片。</p>
<p>来自传统的表单提交的请求结果一般比较简单并且采用多个键值对的方式。例如，当提交一个注册信息的表单时，请求会是这样的：<br><code>firstName=Charles&amp;lastName=Xavier&amp;email=professorx%40xmen.org&amp;username=professorx&amp;password=letmein01</code></p>
<p>虽然这种编码方式对于传统的基于文本的提交是最够的，但是它却没有强大到可以携带二进制数据，比如上传一个图像。相反的，Multipart/form-data将表单分割成独立的部分，每个部分都有各自的类型。传统的表单域都有文本数据，但是当要上传一些东西时，该部分可以是二进制的，如下面的multipart请求体：<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">------WebKitFormBoundaryqgkaBn8IHJCuNmiW</span></span><br><span class="line"><span class="type">Content</span>-<span class="type">Disposition</span>: form-<span class="class"><span class="keyword">data</span>; name="firstName"</span></span><br><span class="line"><span class="type">Charles</span></span><br><span class="line"><span class="comment">------WebKitFormBoundaryqgkaBn8IHJCuNmiW</span></span><br><span class="line"><span class="type">Content</span>-<span class="type">Disposition</span>: form-<span class="class"><span class="keyword">data</span>; name="lastName"</span></span><br><span class="line"><span class="type">Xavier</span></span><br><span class="line"><span class="comment">------WebKitFormBoundaryqgkaBn8IHJCuNmiW</span></span><br><span class="line"><span class="type">Content</span>-<span class="type">Disposition</span>: form-<span class="class"><span class="keyword">data</span>; name="email"</span></span><br><span class="line"><span class="title">charles</span>@xmen.com</span><br><span class="line"><span class="comment">------WebKitFormBoundaryqgkaBn8IHJCuNmiW</span></span><br><span class="line"><span class="type">Content</span>-<span class="type">Disposition</span>: form-<span class="class"><span class="keyword">data</span>; name="username"</span></span><br><span class="line"><span class="title">professorx</span></span><br><span class="line"><span class="comment">------WebKitFormBoundaryqgkaBn8IHJCuNmiW</span></span><br><span class="line"><span class="type">Content</span>-<span class="type">Disposition</span>: form-<span class="class"><span class="keyword">data</span>; name="password"</span></span><br><span class="line"><span class="title">letmein01</span></span><br><span class="line"><span class="comment">------WebKitFormBoundaryqgkaBn8IHJCuNmiW</span></span><br><span class="line"><span class="type">Content</span>-<span class="type">Disposition</span>: form-<span class="class"><span class="keyword">data</span>; name="profilePicture"; filename="me.jpg"</span></span><br><span class="line"><span class="type">Content</span>-<span class="type">Type</span>: image/jpeg</span><br><span class="line">[[ <span class="type">Binary</span> image <span class="class"><span class="keyword">data</span> goes here ]]</span></span><br><span class="line"><span class="comment">------WebKitFormBoundaryqgkaBn8IHJCuNmiW--</span></span><br></pre></td></tr></table></figure></p>
<p>在这个multipart请求中，值得注意的，<code>profilePicture</code>部分是与其他部分不同的，它有一个<code>Content-Type</code>头部用来表示这是一个JPEG图像。虽然不是很明显，profilePicture的内容是一个二进制数据而不是简单文本。</p>
<p>虽然multipart请求看起来比较复杂，但是在Spring MVC中处理起来还是比较简单的。在编写控制器方法来处理文件上传之前，还需要配置一个multipart解析器来告知DispatcherServlet如何读取multipart请求。</p>
<h2><span id="配置multipart解析器">配置multipart解析器</span></h2><p><code>DispatcherServlet</code>并没有实现任何逻辑用来将数据转换成multipart请求。它使用了Spring的<code>MultipartResolver</code>接口的实现类来解析multipart请求中的内容。从Spring3.1开始，Spring提供了两种MultipartResolver实现类供选择：</p>
<ul>
<li>CommonsMultipartResolver：使用Jakarta Commons FileUpload来解析multipart请求；</li>
<li>StandardServletMultipartResolver：依靠Servlet 3.0支持来解析（Spring 3.1及以上）；</li>
</ul>
<p>一般来讲，<code>StandardServletMultipartResolver</code>应该是第一选择。它使用servlet容器中现有的支持，并且不需要其他附加的项目依赖。但是，如果你将应用部署在Servlet 3.0之前的版本，或者你没有使用Spring3.1及以上版本，那么就要使用<code>CommonsMultipartResolver</code>。</p>
<h3><span id="使用servlet-30解析multipart请求">使用Servlet 3.0解析multipart请求</span></h3><p>StandardServletMultipartResolver没有构造器参数和属性需要设置，这样它的设置就比较简单，就像在Spring配置文件中声明一个bean：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> MultipartResolver <span class="title">multipartResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> StandardServletMultipartResolver();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>也许你想这么简单的方法，我该如何加一下限制呢？比如，如何限制一个用户可以上传的文件大小，或者如何设置上传过程中文件的临时存放位置。因为没有构造器和属性可以设置，StandardServletMultipartResolver好像是有限制的。</p>
<p>其实是有办法来设置StandardServletMultipartResolver的，但是它的设置不是在Spring配置中进行的，而是在Servlet配置中。起码要配置一下存放临时文件的位置，进一步来讲，还要将multipart配置为DispatcherServlet的一部分。</p>
<p>如果你是在继承自WebMvcConfigurerAdapter的servlet初始化类中配置的DispatcherServlet，那么就可以在servlet注册时通过调用<code>setMultipartConfig()</code>方法来配置multipart详情。比如：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DispatcherServlet ds = <span class="keyword">new</span> DispatcherServlet();</span><br><span class="line">Dynamic registration = context.addServlet(<span class="string">"appServlet"</span>, ds);</span><br><span class="line">registration.addMapping(<span class="string">"/"</span>);</span><br><span class="line">registration.setMultipartConfig(<span class="keyword">new</span> MultipartConfigElement(<span class="string">"/tmp/spittr/uploads"</span>));</span><br></pre></td></tr></table></figure></p>
<p>如果你是在继承自<code>AbstractAnnotationConfigDispatcherServletInitializer</code>或者<code>AbstractDispatcherServletInitializer</code>的servlet初始化类进行的配置，没有创建DispatcherServlet的实例或者使用servlet上下文对其进行注册。因此就没有直接的引用供<code>Dynamic</code>servlet注册来使用。但是你可以重写<code>customizeRegistration()</code>方法来进行配置：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">customizeRegistration</span><span class="params">(Dynamic registration)</span> </span>&#123;</span><br><span class="line">	registration.setMultipartConfig(<span class="keyword">new</span> MultipartConfigElement(<span class="string">"/tmp/spittr/uploads"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>MultipartConfigElement</code>的唯一参数设置了上传文件时临时文件的存放位置。也可以进行其他一些设置：</p>
<ul>
<li>文件上传的最大值（byte），默认没有限制；</li>
<li>所有multipart请求的文件最大值（byte），不管有多少个请求，默认无限制；</li>
<li>直接上传文件（不需存储到临时目录）的最大值（byte），默认是0，也就是所有的文件都要写入硬盘；</li>
</ul>
<p>例如，你想设置文件大小不超过2MB，所有请求的总和不超过4MB，并且所有文件都要写入硬盘，那么就可以这样设置：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">customizeRegistration</span><span class="params">(Dynamic registration)</span> </span>&#123;</span><br><span class="line">	registration.setMultipartConfig(<span class="keyword">new</span> MultipartConfigElement(<span class="string">"/tmp/spittr/uploads"</span>, <span class="number">2097152</span>, <span class="number">4194304</span>, <span class="number">0</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果你是使用的传统的web.xml的方式来设置的DispatcherServlet，那么就需要使用多个<code>&lt;multipart-config&gt;</code>元素，其默认值和MultipartConfigElement相同，并且<code>&lt;location&gt;</code>是必填项：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>appServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">multipart-config</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">location</span>&gt;</span>/tmp/spittr/uploads<span class="tag">&lt;/<span class="name">location</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">max-file-size</span>&gt;</span>2097152<span class="tag">&lt;/<span class="name">max-file-size</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">max-request-size</span>&gt;</span>4194304<span class="tag">&lt;/<span class="name">max-request-size</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">multipart-config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3><span id="配置jakarta-commons-fileupload解析器">配置Jakarta Commons FileUpload解析器</span></h3><p>最简单的<code>CommonsMultipartResolver</code>声明方式是这样的：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> MultipartResolver <span class="title">multipartResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> CommonsMultipartResolver();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>与StandardServletMultipartResolver不同的是，它不需要配置一个临时目录。默认情况下会使用servlet容器的临时目录。但是，你也可以通过<code>uploadTempDir</code>属性进行设置，同时还可以对其他参数进行设置：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> MultipartResolver <span class="title">multipartResolver</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	CommonsMultipartResolver multipartResolver = <span class="keyword">new</span> CommonsMultipartResolver();</span><br><span class="line">	multipartResolver.setUploadTempDir(<span class="keyword">new</span> FileSystemResource(<span class="string">"/tmp/spittr/uploads"</span>));</span><br><span class="line">	multipartResolver.setMaxUploadSize(<span class="number">2097152</span>);</span><br><span class="line">	multipartResolver.setMaxInMemorySize(<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">return</span> multipartResolver;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里设置了文件的最大大小为2MB，最大的内存中大小为0，即每个上传文件都会直接写入磁盘的。但是它是无法设置multipart请求总的文件大小的。</p>
<h2><span id="处理multipart请求">处理multipart请求</span></h2><p>通过上面的配置，Spring已经支持multipart请求，那么就可以开始编写控制器来处理文件上传了。最普遍的做法就是使用<code>@RequestPart</code>注解一个控制器参数。</p>
<p>假设你想让用户可以在注册时上传图像，那么就需要对注册表单进行更改从而用户可以选择一个图片，同时还需要更改SpitterController中的<code>processRegistration()</code>方法以获取上传的文件。下面的代码是使用Thymeleaf的注册页面：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">  <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"POST"</span> <span class="attr">th:object</span>=<span class="string">"$&#123;spitter&#125;"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="tag">&lt;<span class="name">label</span>&gt;</span>Profile Picture<span class="tag">&lt;/<span class="name">label</span>&gt;</span>:</span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"profilePicture"</span> <span class="attr">accept</span>=<span class="string">"image/jpeg,image/png,image/gif"</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"Register"</span> /&gt;</span></span><br><span class="line">  ...	</span><br><span class="line">```	</span><br><span class="line">可以发现`<span class="tag">&lt;<span class="name">form</span>&gt;</span>`标签多了`enctype="multipart/form-data"`属性，该属性会告知浏览器要将当前form作为multipart数据处理。</span><br><span class="line"></span><br><span class="line">除此之外，还添加了一个新的file类型的`<span class="tag">&lt;<span class="name">input</span>&gt;</span>`标签，该标签允许用户选择一个图片进行上传。`accept`属性设置了允许选择的图片类型。根据它的`name`属性，图片数据会放在`profilePicture`部分进行发送。</span><br><span class="line"></span><br><span class="line">现在所需做的就是更新`processRegistration()`方法，来获取上传的图片，其中一种方法就是添加一个用`@RequestPart`注解的byte数组：</span><br><span class="line">```java</span><br><span class="line">@RequestMapping(value = "/register", method = RequestMethod.POST)</span><br><span class="line">public String processRegistration(@RequestPart("profilePicture") byte[] profilePicture, @Valid Spitter spitter,</span><br><span class="line">		Errors errors) &#123;</span><br></pre></td></tr></table></figure></p>
<p>当注册表单提交时，请求部分的数据就会赋予到<code>profilePicture</code>属性中，如果用户没有选中一个文件，那么该数组就会是一个空值（不是null）。既然已经获取到上传的文件，下面所需要的就是将文件保存。</p>
<h3><span id="接收multipart文件">接收multipart文件</span></h3><p>处理上传文件的原始数据比较简单但是是有局限的，因此，Spring提供了<code>MultipartFile</code>，使用它可以获取到富对象从而更好地处理multipart数据，下面就是<code>MultipartFile</code>接口：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.web.multipart;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MultipartFile</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">getName</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">String <span class="title">getOriginalFilename</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">String <span class="title">getContentType</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getSize</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="keyword">byte</span>[] getBytes() <span class="keyword">throws</span> IOException;</span><br><span class="line">    <span class="function">InputStream <span class="title">getInputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">transferTo</span><span class="params">(File dest)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>MultipartFile</code>提供获取上传文件的方法，同时提供了很多其他方法，比如原始文件名称、大小和内容类型等。另外还提供了一个InputStream可以将文件数据作为数据流读取。</p>
<p>另外，<code>MultipartFile</code>还提供了一个方便的<code>transferTo()</code>方法帮助你将上传文件写入到文件系统。例如，你可以将如下代码加入到<code>processRegistration()</code>中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">profilePicture.transferTo(<span class="keyword">new</span> File(<span class="string">"/data/spittr/"</span> + profilePicture.getOriginalFilename()));</span><br></pre></td></tr></table></figure></p>
<p>像这样将文件保存到本地文件系统非常简单，但是将文件管理的工作留给了你。你需要保证有足够的空间，保证对文件进行了备份以防硬件问题。同事还需要进行多服务器之间的文件同步。</p>
<h3><span id="将文件保存到amazon-s3">将文件保存到Amazon S3</span></h3><p>另外的办法就是将上面这些都托管给其他人，可以存放在云端，下面的代码可以将上传的图像保存到Amazon S3：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">saveImage</span><span class="params">(MultipartFile image)</span> <span class="keyword">throws</span> ImageUploadException </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		AWSCredentials awsCredentials = <span class="keyword">new</span> AWSCredentials(s3AccessKey, s2SecretKey);</span><br><span class="line">		<span class="comment">// 配置S3服务</span></span><br><span class="line">		S3Service s3 = <span class="keyword">new</span> RestS3Service(awsCredentials);</span><br><span class="line">		<span class="comment">// 创建S3 bucket对象</span></span><br><span class="line">		S3Bucket bucket = s3.getBucket(<span class="string">"spittrImages"</span>);</span><br><span class="line">		S3Object imageObject = <span class="keyword">new</span> S3Object(image.getOriginalFilename());</span><br><span class="line">		<span class="comment">// 设置图像数据</span></span><br><span class="line">		imageObject.setDataInputStream(image.getInputStream());</span><br><span class="line">		imageObject.setContentLength(image.getSize());</span><br><span class="line">		imageObject.setContentType(image.getContentType());</span><br><span class="line">		AccessControlList acl = <span class="keyword">new</span> AccessControlList();</span><br><span class="line">		<span class="comment">// 设置权限</span></span><br><span class="line">		acl.setOwner(bucket.getOwner());</span><br><span class="line">		acl.grantPermission(GroupGrantee.ALL_USERS, Permission.PERMISSION_READ);</span><br><span class="line">		imageObject.setAcl(acl);</span><br><span class="line">		<span class="comment">// 保存图片</span></span><br><span class="line">		s3.putObject(bucket, imageObject);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> ImageUploadException(<span class="string">"Unable to save image"</span>, e);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>saveImage()的第一步就是设置Amazon Web Service (AWS)认证，你需要提供S3的密钥和私钥，这些在注册S3服务时Amazon都会给你的。</p>
<p>认证过AWS之后，saveImage()创建了一个JetS3t的<code>RestS3Service</code>实例，可以通过它操作S3文件系统。它会获取一个<code>spittrImages</code>的bucket引用，并创建用于包含图标的S3Object对象，然后将突破数据填充到S3Object中。</p>
<p>在调用<code>putObject()</code>方法将图片数据写入S3之前，saveImage()方法设置了S3Object的权限，允许有所有用户查看。这很重要，因为如果没有设置的话，那么这些图片对于应用程序的用户来说都是不可见得了。如果出现什么问题的话，会抛出<code>ImageUploadException</code>异常。</p>
<h3><span id="接收上传文件为part">接收上传文件为Part</span></h3><p>如果你将应用部署在Servlet 3.0的容器上，那么你可以选择不使用MultipartFile，Spring MVC也可以将<code>javax.servlet.http.Part</code>作为控制器的入参，使用<code>Part</code>后processRegistration()方法就是这样的了：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/register"</span>, method = RequestMethod.POST)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">processRegistration</span><span class="params">(@RequestPart(<span class="string">"profilePicture"</span>)</span> Part profilePicture, @Valid Spitter spitter,</span></span><br><span class="line"><span class="function">		Errors errors) </span>&#123;</span><br></pre></td></tr></table></figure></p>
<p>大多数情况下<code>Part</code>接口和<code>MultipartFile</code>没什么区别，如下面的代码所示：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> javax.servlet.http;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Part</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> InputStream <span class="title">getInputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getContentType</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSubmittedFileName</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getSize</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(String fileName)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getHeader</span><span class="params">(String name)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">getHeaders</span><span class="params">(String name)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">getHeaderNames</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>一些方法就是名称上的不同，比如<code>getSubmittedFileName()</code>和<code>getOriginalFilename()</code>是对应的。<code>write()</code>和<code>transferTo()</code>是对应的，可以这样使用：<br><code>profilePicture.write(&quot;/data/spittr/&quot; + profilePicture.getOriginalFilename());</code></p>
<p>值得注意的是，如果你使用<code>Part</code>作为参数，那么就不再需要配置<code>StandardServletMultipartResolver</code>bean，它只需在使用MultipartFile时进行配置。</p>
<h1><span id="异常处理">异常处理</span></h1><p>一直以来我们都是假设Spittr应用中的一切都是正常运行的，但是如果哪里出现错误了呢？或者在处理请求时出现了异常？这时该向客户端发送什么响应呢？</p>
<p>不论发生什么，好的或者坏的，一个servlet请求的输出只能是一个servlet响应。如果在处理请求的过程中出现异常，输出结果仍然是一个servlet响应，需要将异常转换为一个响应。</p>
<p>Spring提供了一些将异常转化为响应的方法：</p>
<ul>
<li>某些Spring异常会自动的映射为特定的HTTP状态码；</li>
<li>使用<code>@ResponseStatus</code>注解将一个异常映射为HTTP状态码；</li>
<li>使用<code>ExceptionHandler</code>注解的方法可以用来处理异常</li>
</ul>
<h2><span id="映射异常为http状态码">映射异常为HTTP状态码</span></h2><p>Spring可以自动地将其异常映射为状态码，如下表：</p>
<table>
<thead>
<tr>
<th>Spring异常</th>
<th>HTTP状态码</th>
</tr>
</thead>
<tbody>
<tr>
<td>BindException</td>
<td>400 - Bad Request</td>
</tr>
<tr>
<td>ConversionNotSupportedException</td>
<td>500 - Internal Server Error</td>
</tr>
<tr>
<td>HttpMediaTypeNotAcceptableException</td>
<td>406 - Not Acceptable</td>
</tr>
<tr>
<td>HttpMediaTypeNotSupportedException</td>
<td>415 - Unsupported Media Type</td>
</tr>
<tr>
<td>HttpMessageNotReadableException</td>
<td>400 - Bad Request</td>
</tr>
<tr>
<td>HttpMessageNotWritableException</td>
<td>500 - Internal Server Error</td>
</tr>
<tr>
<td>HttpRequestMethodNotSupportedException</td>
<td>405 - Method Not Allowed</td>
</tr>
<tr>
<td>MethodArgumentNotValidException</td>
<td>400 - Bad Request</td>
</tr>
<tr>
<td>MissingServletRequestParameterException</td>
<td>400 - Bad Request</td>
</tr>
<tr>
<td>MissingServletRequestPartException</td>
<td>400 - Bad Request</td>
</tr>
<tr>
<td>NoSuchRequestHandlingMethodException</td>
<td>404 - Not Found</td>
</tr>
<tr>
<td>TypeMismatchException</td>
<td>400 - Bad Request</td>
</tr>
</tbody>
</table>
<p>表格里的异常通常是在DispatcherServlet中出错由Spring自身抛出的。例如，如果DispatcherServlet无法找到合适的控制器来处理请求，那么就会抛出<code>NoSuchRequestHandlingMethodException</code>，对应的状态码就是404。</p>
<p>虽然这些内置的映射有点用，但是不一定适用于其他的应用异常。还好，Spring提供了<code>@ResponseStatus</code>注解将一个异常映射为HTTP状态码。</p>
<p>比如下面SpittleController中的请求处理方法就可以返回HTTP 404状态：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/&#123;spittleId&#125;"</span>, method = RequestMethod.GET)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">spittle</span><span class="params">(@PathVariable(<span class="string">"spittleId"</span>)</span> <span class="keyword">long</span> spittleId, Model model) </span>&#123;</span><br><span class="line">	Spittle spittle = spittleRepository.findOne(spittleId);</span><br><span class="line">	<span class="keyword">if</span> (spittle == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> SpittleNotFoundException();</span><br><span class="line">	&#125;</span><br><span class="line">	model.addAttribute(spittle);</span><br><span class="line">	<span class="keyword">return</span> <span class="string">"spittle"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果<code>findOne()</code>方法返回了一个null，那么就会抛出SpittleNotFoundException。这里，<code>SpittleNotFoundException</code>就是一个未经检查的异常：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> spittr.web;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpittleNotFoundException</span> <span class="keyword">extends</span> <span class="title">Exception</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果在处理请求时调用了spittle()方法，并且传入的ID是空的，那么SpittleNotFoundException就会默认产生500的响应。实际上，如果没有找到对应的映射都会返回500的错误。但是你也可以通过对SpittleNotFoundException进行映射改变这种情况。</p>
<p>当抛出SpittleNotFoundException时就表示一个请求的资源不存在，404恰好符合这种情况。那么，我们就使用<code>@ResponseStatus</code>来将其映射到404。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> spittr.web;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseStatus;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ResponseStatus</span>(value=HttpStatus.NOT_FOUND, reason=<span class="string">"Spittle Not Found"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpittleNotFoundException</span> <span class="keyword">extends</span> <span class="title">Exception</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2><span id="编写异常处理方法">编写异常处理方法</span></h2><p>将异常映射为状态码大多数情况下是比较简单有效的，但是如果想让响应不仅仅只有一个状态码呢？也许你想对异常进行一些处理，就行处理请求一样。</p>
<p>例如，SpittleRepository的save()方法在用户重复创建Spittle时抛出了一个DuplicateSpittleException，那么SpittleController的saveSpittle()方法就需要处理该异常。如下面的代码所示，saveSpittle()方法可以直接处理该异常：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(method = RequestMethod.POST)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">saveSpittle</span><span class="params">(SpittleForm form, Model model)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		spittleRepository.save(<span class="keyword">new</span> Spittle(<span class="keyword">null</span>, form.getMessage(), </span><br><span class="line">				<span class="keyword">new</span> Date(), form.getLongitude(), form.getLatitude()));</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"redirect:/spittles"</span>;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (DuplicateSpittleException e) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"error/duplicate"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面的代码并没有什么特别的，这就是一个简单的Java异常处理。</p>
<p>这样做还可以，但是这个方法有点复杂。如果saveSpittle()方法专注于业务处理，让其他方法来处理异常该多好。下面就为SpittleController添加一个新的方法来处理DuplicateSpittleException异常：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExceptionHandler</span>(DuplicateSpittleException.class)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">handleDuplicateSpittle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">"error/duplicate"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>@ExceptionHandler</code>注解应用在handleDuplicateSpittle()方法上，用来指定在有DuplicateSpittleException异常抛出时执行。</p>
<p>有意思的是，<code>@ExceptionHandler</code>注解的方法在同一个控制器里是通用的额，即无论SpittleController的哪一个方法抛出DuplicateSpittleException异常，handleDuplicateSpittle()方法都可以对其进行处理，而不再需要在每一个出现异常的地方进行捕获。</p>
<p>也许你在想，<code>@ExceptionHandler</code>注解的方法能不能捕获其他controller里的异常啊？在Spring3.2里是可以的，但仅仅局限于定义在控制器增强类（controller advice class）里的方法。</p>
<p>那么什么是控制器增强类呢？下面我们就来看看这个控制器增强类。</p>
<h1><span id="控制器增强类controller-advice-class">控制器增强类（controller advice class）</span></h1><p>如果controller类的特定切面可以跨越应用的所有controller进行使用，那么这将会带来极大的便捷。例如，<code>@ExceptionHandler</code>方法就可以处理多个controller抛出的异常了。如果多个controller类都抛出同一个异常，也许你会在这些controller进行重复的<code>@ExceptionHandler</code>方法编写。或者，你也可以编写一个异常处理的基类，供其他<code>@ExceptionHandler</code>方法进行继承。</p>
<p>Spring3.2带来了另外一种处理方法：控制器增强类，即使用<code>@ControllerAdvice</code>进行注解的类，它们会有下面几个方法构成：</p>
<ul>
<li><code>@ExceptionHandler</code>注解的</li>
<li><code>@InitBinder</code>注解的</li>
<li><code>@ModelAttribute</code>注解的</li>
</ul>
<p><strong><code>@ControllerAdvice</code>注解的类中的这些方法会在整个应用中的所有controller的所有<code>@RequestMapping</code>注解的方法上应用。</strong></p>
<p><code>@ControllerAdvice</code>注解本身是使用了<code>@Component</code>注解的，因此，使用<code>@ControllerAdvice</code>注解的类会在组件扫描时进行提取，就行使用<code>@Controller</code>注解的类一样。</p>
<p><code>@ControllerAdvice</code>的最实用的一个功能就是将所有的<code>@ExceptionHandler</code>方法集成在一个类中，从而可以在一个地方处理所有controller中的异常。例如，假设你想处理应用中所有的DuplicateSpittleException异常，可以采用下面的方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> spittr.web;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ControllerAdvice;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ExceptionHandler;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 声明控制器增强</span></span><br><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppWideExceptionHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 定义异常处理方法</span></span><br><span class="line">	<span class="meta">@ExceptionHandler</span>(DuplicateSpittleException.class)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">handleDuplicateSpittle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"error/duplicate"</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@ExceptionHandler</span>(SpittleNotFoundException.class)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">handleSpittleNotFound</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"error/duplicate"</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>现在，不论哪一个controller抛出DuplicateSpittleException，都会调用handleDuplicateSpittle()方法来处理。</p>
<h1><span id="在redirect请求中携带数据">在redirect请求中携带数据</span></h1><p>正如前文提到的，在处理完一个POST请求后进行重定向是一个不错的选择，起码这样可以避免用户点击刷新造成的POST请求重发的问题。</p>
<p>在第五章中，已经在控制器方法返回的视图名称中使用了<code>redirect:</code>前缀，这时返回的String不是用来寻找视图，而是浏览器进行跳转的路径：<br><code>return &quot;redirect:/spitter/&quot; + spitter.getUsername();</code></p>
<p>也许你认为Spring处理重定向只能这样了，但是等等：Spring还可以做得更多。</p>
<p>特别是一个重定向方法如何向处理重定向的方法发送数据呢？一般的，当一个处理函数结束后，方法中的model数据都会作为request属性复制到request中，并且request会传递到视图中进行解析。因为控制器和视图面对的是同一个request，因此request属性在forward时保留了下来。</p>
<p>但是，当一个控制器返回的是一个redirect时，原来的request会终止，并且会开启一个新的HTTP请求。原来request中所有的model数据都会清空。新的request不会有任何的model数据。</p>
<p><img src="http://hoxis-github-io.qiniudn.com/160428-spring-in-action-7.1.png" alt="Model属性会作为request的属性但是不能再redirect中传递"></p>
<p>明显的，现在不能再redirect时使用model来传递数据了。但是还有其他方法用来从重定向的方法中获取数据：</p>
<ul>
<li>将数据转换为路径参数或者查询参数</li>
<li>在flash属性中发送数据<br>首先来看一下Spring如何在路径参数或者查询参数中传递数据。</li>
</ul>
<h2><span id="使用url模版重定向">使用URL模版重定向</span></h2><p>将数据转化为路径参数和查询参数看起来比较简单。在之前的代码里，新建的Spitter的username就是作为路径参数进行传递的。但是这里的username是转换为String进行传递的。使用String传递URL和SQL时是比较危险的事情。</p>
<p>除了使用重定向链接，Spring提供了使用模版来定义重定向链接。例如下面的代码：<br><code>return &quot;redirect:/spitter/{username}&quot;;</code></p>
<p>你所需做的就是设置model中的相关值。因此，processRegistration()方法需要接收model作为入参，并将username设置其中。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/register"</span>, method=POST)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">processRegistration</span><span class="params">(Spitter spitter, Model model)</span> </span>&#123;</span><br><span class="line">    spitterRepository.save(spitter);</span><br><span class="line">    model.addAttribute(<span class="string">"username"</span>, spitter.getUsername());</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"redirect:/spitter/&#123;username&#125;"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>由于这里使用了占位符而不是直接使用重定向String进行连接，就可以将username中的不安全字符隐藏起来。这样就比让用户直接输入username并将其添加到路径后面要更加安全。</p>
<p>另外，model中其他的原始值也会作为查询参数添加到重定向URL中。例如，除了username，model同时也包括新建的Spitter对象的id属性：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/register"</span>, method=POST)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">processRegistration</span><span class="params">(Spitter spitter, Model model)</span> </span>&#123;</span><br><span class="line">    spitterRepository.save(spitter);</span><br><span class="line">    model.addAttribute(<span class="string">"username"</span>, spitter.getUsername());</span><br><span class="line">    model.addAttribute(<span class="string">"spitterId"</span>, spitter.getId());</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"redirect:/spitter/&#123;username&#125;"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>返回的重定向String并没有什么变化，但是由于model中的spitterId属性并没有映射到URL中的占位符，它会自动作为查询参数。</p>
<p>如果<code>username</code>是habuma，<code>spitterId</code>是42，那么返回的重定向路径将是<code>/spitter/habuma?spitterId=42</code>。</p>
<p>使用路径参数和查询参数传递数据比较简单，但是它也有局限性。它只适用于传递简单值，比如String和数字，不能传递比较复杂的东西，那么我们就需要flash属性来帮忙。</p>
<h2><span id="使用flash属性">使用flash属性</span></h2><p>比如说你不再是想在重定向中传送一个username或者ID，而是传送一个真正的Spitter对象。如果只传送了一个ID，那么处理重定向的方法不得不去数据库中查找该对象。但是在重定向之前你已经有有一个Spitter对象了，为什么不将它传送给重定向处理方法呢？</p>
<p>Spitter对象不像String或者int那么简单，因此不能作为路径参数或者查询参数进行传送。但是，它可以作为model的一个属性。</p>
<p>但是在上面的讨论中，model属性最终都会拷贝到request中，并随着redirect的触发而消失。因此，你需要将Spitter对象放在一个会随着redirect存活的地方。</p>
<p>其中一个方法是将其放在session中，session是可以长期存活的，可以跨越多个request。因此，你可以将Spitter对象在redirect之前放在session中，并在redirect之后取出。当然你还要在取出之后将其从session中清理。</p>
<p>事实证明，Spring允许将数据存放在session中，从而在redirect时传递数据。但是Spring认为你不应该负责管理这些数据。相反，Spring提供了将数据作为<code>flash</code>属性进行传送的功能。<code>Flash</code>属性，即在到下一个request之前一直携带数据，然后它们就走了。</p>
<p>Spring提供了通过<code>RedirectAttributes</code>来设置<code>flash</code>属性，<code>RedirectAttributes</code>作为<code>Model</code>的子接口，新增了一些方法用来设置<code>flash</code>属性。</p>
<p>特别的，<code>RedirectAttributes</code>提供了<code>addFlashAttribute()</code>方法用来添加<code>flash</code>属性。那么就可以利用它来重写processRegistration()方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/register"</span>, method=POST)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">processRegistration</span><span class="params">(Spitter spitter, RedirectAttributes model)</span> </span>&#123;</span><br><span class="line">    spitterRepository.save(spitter);</span><br><span class="line">    model.addAttribute(<span class="string">"username"</span>, spitter.getUsername());</span><br><span class="line">    model.addFlashAttribute(<span class="string">"spitter"</span>, spitter);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"redirect:/spitter/&#123;username&#125;"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里，可以调用addFlashAttribute()方法将Spitter对象作为一个值添加到flash属性中。另外，你也可以不填对应的key值：<br><code>model.addFlashAttribute(spitter);</code><br>由于你传递了一个Spitter对象，因此key会自动生成为<code>spitter</code>。</p>
<p>在重定向之前，所有的flash属性都会拷贝到session中，在重定向之后，存储在session中的flash属性会从session中移出到model中。然后处理重定向请求的方法就可以使用Spitter对象了，如下图所示：</p>
<p><img src="http://hoxis-github-io.qiniudn.com/160428-spring-in-action-7.2.png" alt="flash属性都会拷贝到session中，然后转存到model中"></p>
<p>下面对showSpitterProfile()进行一点点更，在从数据库查找之前对Spitter进行检查：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/&#123;username&#125;"</span>, method = RequestMethod.GET)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">showSpitterProfile</span><span class="params">(@PathVariable(<span class="string">"username"</span>)</span> String username, Model model) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!model.containsAttribute(<span class="string">"spitter"</span>)) &#123;</span><br><span class="line">		Spitter spitter = spitterRepository.findByUsername(username);</span><br><span class="line">		model.addAttribute(spitter);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">"profile"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>正如你所见，该方法的第一件事是检查model中是否含有spitter的属性，如果有就啥也不做了。Spitter对象会被直接传送到视图中进行解析。如果没有再去数据库里查。</p>
<h1><span id="总结">总结</span></h1><p>每当使用Spring时，好像总有更多：更多的特性、更多的选择以及更多的途径可以达到目标，Spring MVC有很多花样繁多的功能。</p>
<p>Spring MVC的配置就是一个你需要进行选择的地方。本章中，我们从如何配置Spring MVC的<code>DispatcherServlet</code>和<code>ContextLoaderListener</code>说起。你可以看到如何进行<code>DispatcherServlet</code>注册以及其他的servlet和filter的注册。另外，如果将应用部署在比较旧的容器上，我们还可以使用<code>web.xml</code>进行配置。</p>
<p>接着，我们看了如何处理Spring MVC控制器抛出的异常。尽管<code>@RequestMapping</code>方法可以处理异常，如果你将异常处理部分抽取出来那么你的代码就会比较清爽。</p>
<p>为了完成通用的任务，比如异常处理，会在整个应用中使用，Spring3.2开始提供了<code>@ControllerAdvice</code>来创建增强型控制器，从而可以在一个地方完成通用的异常处理。</p>
<p>最后，我们研究了如何在重定向时传递数据，那就是使用Spring的<code>flash</code>属性。</p>
<p>至此，也许你会觉得，不过如此嘛！但是我们讨论的仅仅是Spring MVC功能的一小部分。在16章中我们还会讨论其他功能，比如如何利用它来创建REST API。</p>
<p>下面的章节，我们先放一放Spring MVC，来看一下Spring Web Flow，这是一个流框架，是Spring MVC的扩展，它能够在Spring中实现面向会话的Web开发。</p>

      
    </div>
    
    
    

    
      <div>
        <div id="wechat_subscriber" style="display: block; padding: 10px 0; margin: 20px auto; width: 100%; text-align: center">
    <img id="wechat_subscriber_qcode" src="/uploads/wechat-qcode.png" alt="hoxis wechat" style="width: auto; height:200px; max-width: 100%;">
    <div>一个脱离了高级趣味的程序员，关注回复1024有惊喜~</div>
</div>

      </div>
    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>赞赏一杯咖啡</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/uploads/wechatpay.jpg" alt="hoxis 微信支付">
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/uploads/alipay.jpg" alt="hoxis 支付宝">
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    
      <div>
        <ul class="post-copyright">
  <!--
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    hoxis
  </li>
  -->
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    hoxis  |  微信公众号【不正经程序员】
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://hoxis.github.io/《Spring实战》学习笔记-第七章：Spring MVC进阶.html" title="《Spring实战》学习笔记-第七章：Spring MVC进阶">https://hoxis.github.io/《Spring实战》学习笔记-第七章：Spring MVC进阶.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/deed.zh" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
  <li class="post-copyright-license">
    并保留本声明和上方二维码。感谢您的阅读和支持！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Spring/" rel="tag"><i class="fa fa-tag"></i> Spring</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/《Spring实战》学习笔记-第六章：web视图解析.html" rel="next" title="《Spring实战》学习笔记-第六章：web视图解析">
                <i class="fa fa-chevron-left"></i> 《Spring实战》学习笔记-第六章：web视图解析
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/《Spring实战》学习笔记-第八章：使用Spring Web Flow.html" rel="prev" title="《Spring实战》学习笔记-第八章：使用Spring Web Flow">
                《Spring实战》学习笔记-第八章：使用Spring Web Flow <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
        
  <script>
    window._bd_share_config = {
      "common": {
        "bdText": "",
        "bdMini": "1",
        "bdMiniList": false,
        "bdPic": ""
      },
      "image": {
        "viewList": ["tsina", "douban", "sqq", "qzone", "weixin", "twi", "fbook"],
        "viewText": "分享到：",
        "viewSize": "16"
      },
      "slide": {
        "bdImg": "5",
        "bdPos": "left",
        "bdTop": "100"
      }
    }
  </script>

<script>
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

      
    </div>
  </div>


          </div>
			</div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



          
        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/uploads/avatar.png" alt="hoxis">
            
              <p class="site-author-name" itemprop="name">hoxis</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">266</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">24</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">131</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a rel="external nofollow" href="https://github.com/hoxis" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  <a rel="external nofollow" href="https://www.zhihu.com/people/mobi/posts" target="_blank" title="知乎">
                    
                      <i class="fa fa-fw fa-globe"></i>知乎</a>
                </span>
              
            
          </div>

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友链
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://lbjheiheihei.xyz/" title="伪君子的梦呓" rel="external nofollow" target="_blank">伪君子的梦呓</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.kindkp.com" title="发现精品星球" rel="external nofollow" target="_blank">发现精品星球</a>
                  </li>
                
              </ul>
            </div>
          
          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <!-- modify icon to fire by szw -->
                <i class="fa fa-history fa-" aria-hidden="true"></i>
                近期文章
              </div>
              <ul class="links-of-blogroll-list">
                
                
                  <li>
                    <a href="/Windows11.html" title="Win11系统镜像下载地址+安装教程" target="_blank">Win11系统镜像下载地址+安装教程</a>
                  </li>
                
                  <li>
                    <a href="/weixindushu.html" title="微信读书无限卡白嫖攻略" target="_blank">微信读书无限卡白嫖攻略</a>
                  </li>
                
                  <li>
                    <a href="/weixin-windows-3.3.html" title="微信Windows版可以刷朋友圈了，微信3.3.0内测版安装包" target="_blank">微信Windows版可以刷朋友圈了，微信3.3.0内测版安装包</a>
                  </li>
                
                  <li>
                    <a href="/ali-yun-pan.html" title="阿里云盘如何分享文件？" target="_blank">阿里云盘如何分享文件？</a>
                  </li>
                
                  <li>
                    <a href="/luping.html" title="oCam屏幕录像机绿色版" target="_blank">oCam屏幕录像机绿色版</a>
                  </li>
                
              </ul>
            </div>
        

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-text">Spring MVC备用配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-text">DispatcherServlet个性化配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-text">添加额外的servlet和filter</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-text">使用web.xml声明DispatcherServlet</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-text">处理multipart表单数据</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-text">配置multipart解析器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#undefined"><span class="nav-text">使用Servlet 3.0解析multipart请求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#undefined"><span class="nav-text">配置Jakarta Commons FileUpload解析器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-text">处理multipart请求</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#undefined"><span class="nav-text">接收multipart文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#undefined"><span class="nav-text">将文件保存到Amazon S3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#undefined"><span class="nav-text">接收上传文件为Part</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-text">异常处理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-text">映射异常为HTTP状态码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-text">编写异常处理方法</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-text">控制器增强类（controller advice class）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-text">在redirect请求中携带数据</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-text">使用URL模版重定向</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-text">使用flash属性</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2015 &mdash; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">hoxis</span>

  
</div>









        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      本站已有
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      位访客  <i class="fa fa-user"></i>
    </span>
  

  
    <span class="site-pv">
      
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      人阅读  <i class="fa fa-eye"></i>
    </span>
  
</div>





  <script type="text/javascript">
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId=65591650";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  
  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'Fo8lyzaHoPOI1RWT37jTn36p-gzGzoHsz',
        appKey: 'kLufSGh3R0S56mMQgG9495oK',
        placeholder: '来都来了，不撩一句嘛~，留言记得在上面留下【邮箱】，方便收到回复通知~',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>





  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("Fo8lyzaHoPOI1RWT37jTn36p-gzGzoHsz", "kLufSGh3R0S56mMQgG9495oK");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  

  

  


</body>
</html>
